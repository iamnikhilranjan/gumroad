<%= javascript_tag nonce: SecureHeaders.content_security_policy_script_nonce(request) do %>
  document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelector('[data-office-carousel-slides]');
    const prevButton = document.querySelector('[data-office-carousel-prev]');
    const nextButton = document.querySelector('[data-office-carousel-next]');
    if (!images || !prevButton || !nextButton) return;

    const count = images.children.length - 2;
    let index = 1;
    let transitioning = false;

    function show(i, instant) {
      images.style.transition = instant ? 'none' : 'transform 0.5s ease-in-out';
      const width = images.parentElement.offsetWidth;
      const gap = parseFloat(getComputedStyle(images).gap) || (window.innerWidth >= 768 ? 64 : 24);
      Array.from(images.children).forEach(child => child.style.width = `${width}px`);
      images.style.transform = `translateX(-${i * (width + gap)}px)`;
    }

    function move(direction) {
      if (transitioning) return;
      transitioning = true;
      const atEnd = direction === 1 && index === count;
      const atStart = direction === -1 && index === 1;

      if (atEnd) {
        index = count + 1;
        show(index);
        setTimeout(() => { index = 1; show(index, true); transitioning = false; }, 500);
      } else if (atStart) {
        index = 0;
        show(index);
        setTimeout(() => { index = count; show(index, true); transitioning = false; }, 500);
      } else {
        index += direction;
        show(index);
        setTimeout(() => { transitioning = false; }, 500);
      }
    }

    window.addEventListener('resize', () => show(index, true));
    nextButton.addEventListener('click', () => move(1));
    prevButton.addEventListener('click', () => move(-1));
    show(1, true);
  });
<% end %>
