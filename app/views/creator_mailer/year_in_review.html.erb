<% formatted_total_amount = Money.new(@analytics_data[:total_amount_cents] * get_rate(@seller.currency_type).to_f, @seller.currency_type.to_sym).format(no_cents_if_whole: true, symbol: true) %>

<div style="background-color: #FF90E8">
  <h2 style="text-align: center;">Your year on Gumroad in review</h2>
</div>

<div>
  <table class="reset stats">
    <tbody>
      <tr>
        <td>
          <div>Sales</div>
          <div><%= number_with_delimiter(@analytics_data[:total_sales_count]) %></div>
        </td>
        <td>
          <div>Views</div>
          <div><%= number_with_delimiter(@analytics_data[:total_views_count]) %></div>
        </td>
      </tr>
      <tr>
        <td>
          <div>Unique customers</div>
          <div><%= number_with_delimiter(@analytics_data[:total_unique_customers_count]) %></div>
        </td>
        <td>
          <div>Products sold</div>
          <div><%= number_with_delimiter(@analytics_data[:total_products_sold_count]) %></div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<% if @analytics_data[:top_selling_products].present? %>
  <div>
    <h2 style="text-align: center;">Your top <%= @analytics_data[:top_selling_products].count > 1 ? "#{@analytics_data[:top_selling_products].count} products" : "product" %></h2>
  </div>

  <% @analytics_data[:top_selling_products].each do |product| %>
    <div class="item" style="display: contents">
      <%= render("shared/mailers/product_as_checkout_cell", product: product) do %>
        <% views, sales, total = product[:stats] %>
        <div class="footer product-stats" title="Analytics">
          <span>
            <%= image_tag("email/eye-fill.png", alt: "Views") %>
            <%= number_to_si(views) %>
          </span>
          <span>
            <%= image_tag("email/cart3-fill.png", alt: "Sales") %>
            <%= number_to_si(sales) %>
          </span>
          <span>
            <%= image_tag("email/solid-currency-dollar.png", alt: "Total") %>
            <%= number_to_si(total) %>
          </span>
        </div>
      <% end %>
    </div>
  <% end %>
<% end %>

<div>
  <h2 style="text-align: center;">You sold products in <%= pluralize(@analytics_data[:total_countries_with_sales_count], "country") %></h2>
</div>

<div>
  <table class="reset list">
    <colgroup>
      <col style="width: 45%;">
      <col style="width: 18%;">
      <col style="width: 18%;">
      <col style="width: 19%;">
    </colgroup>
    <thead>
      <tr>
        <th style="text-align: left;">Country</th>
        <th style="text-align: right; white-space: nowrap;">
          Views
        </th>
        <th style="text-align: right; white-space: nowrap;">
          Sales
        </th>
        <th style="text-align: right;">Total</th>
      </tr>
    </thead>
    <tbody>
      <% @analytics_data[:by_country].each do |(country, (views, sales, total))|
        money = Money.new(total * 100 * get_rate(@seller.currency_type).to_f, @seller.currency_type.to_sym)
      %>
        <tr>
          <td style="text-align: left;"><%= country %></td>
          <td style="text-align: right; white-space: nowrap;">
            <%= number_to_si(views) %>
          </td>
          <td style="text-align: right; white-space: nowrap;">
            <%= number_to_si(sales) %>
          </td>
          <td style="text-align: right; white-space: nowrap;">
            <%= "#{money.symbol}#{number_to_si(money.dollars)}" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div>
  <h2 style="text-align: center;">You earned a total of <%= formatted_total_amount %></h2>
</div>

<% if attachments[@buy_suggestion_image_filename].present? %>
  <div>
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
      <%= image_tag("email/gpt3_gumroad.png", alt: "Gumroad logo", style: "width: 32px; height: 36px; max-width: 100%; height: auto;") %>
      <span style="font-size: 16px;">Congrats! You can now treat yourself to...</span>
    </div>
    <%= image_tag(attachments[@buy_suggestion_image_filename].url, alt: "Treat yourself", style: "display: block; width: 100%; max-width: 420px; margin: 0 auto; border-radius: 4px; border: 1px solid #000; object-fit: cover;") %>
  </div>
<% end %>

<% if @seller.from_us? %>
  <div>
    <div role="status" class="info">
      <div>
        <table class="reset">
          <tbody>
            <tr>
              <td>
                <%= image_tag("email/icon_info_circle_fill.png") %>
              </td>
              <td>
                <% if @seller.eligible_for_1099?(@year) %>
                  You'll be receiving a 1099 from us in the next few weeks.
                <% else %>
                  You do not qualify for a 1099 this year.
                <% end %>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% end %>

<% if @payout_csv_url.present? %>
  <div>
    <h2 style="text-align: center;">Here's your financial report for <%= @year %>!</h2>
    <p>Please click this <%= link_to "link", @payout_csv_url %> to download the payout summary.</p>
  </div>
<% end %>
